<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>接口小助手</title>
    <style>
      body {
        font-family:
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Helvetica,
          Arial;
        padding: 16px;
        max-width: 900px;
        margin: 0 auto;
      }
      .row {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
      }
      input,
      select,
      textarea,
      button {
        font: inherit;
        padding: 10px;
      }
      input,
      textarea {
        width: 100%;
      }
      textarea {
        min-height: 140px;
      }
      button {
        cursor: pointer;
      }
      pre {
        background: #f6f8fa;
        padding: 12px;
        overflow: auto;
      }
      .muted {
        color: #666;
        font-size: 12px;
      }
      #history button {
        margin: 4px 6px 4px 0;
        padding: 6px 10px;
      }
    </style>
  </head>
  <body>
    <h2>接口小助手</h2>
    <div class="row">
      <select id="method">
        <option>GET</option>
        <option>POST</option>
      </select>
      <input id="url" placeholder="https://api.example.com/..." />
      <button id="send">发送</button>
    </div>

    <div class="row" id="bodyRow">
      <textarea
        id="body"
        placeholder='POST Body（JSON），例如：{"name":"alice"}'
      ></textarea>
    </div>

    <div class="muted" id="meta">未发送</div>

    <div class="muted">历史（点击回填）</div>
    <div id="history"></div>

    <pre id="out">(结果会显示在这里)</pre>

    <script>
      const $ = (id) => document.getElementById(id);
      function renderHistory() {
        const history = JSON.parse(localStorage.getItem("history") || "[]");
        const box = $("history");
        box.innerHTML = "";

        history.forEach((item, idx) => {
          const btn = document.createElement("button");
          btn.textContent = `${idx + 1}. ${item.method} ${item.url}`;
          btn.addEventListener("click", () => {
            $("method").value = item.method;
            $("url").value = item.url;
            $("body").value = item.body || "";
            $("method").dispatchEvent(new Event("change")); // 同步隐藏/显示 body
          });
          box.appendChild(btn);
        });

        if (history.length === 0) {
          box.textContent = "(暂无)";
        }
      }

      renderHistory();
      // 监听 method 下拉变化
      $("method").addEventListener("change", () => {
        const isPost = $("method").value === "POST";
        $("bodyRow").style.display = isPost ? "flex" : "none";
      });
      $("method").dispatchEvent(new Event("change"));

      $("send").addEventListener("click", async () => {
        const method = $("method").value;
        const url = $("url").value.trim();
        const bodyText = $("body").value.trim();

        if (!url) {
          alert("先填 URL");
          return;
        }

        const t0 = performance.now();
        $("meta").textContent = "请求中...";
        $("out").textContent = "";

        try {
          const options = { method, headers: {} };

          if (method === "POST") {
            options.headers["Content-Type"] = "application/json";
            if (bodyText) {
              // 这里故意强制 parse：让你立刻暴露 JSON 格式问题
              options.body = JSON.stringify(JSON.parse(bodyText));
            } else {
              options.body = "{}";
            }
          }

          const res = await fetch(url, options);
          const ms = Math.round(performance.now() - t0);

          const text = await res.text();
          let pretty = text;
          try {
            const obj = JSON.parse(text);
            pretty = JSON.stringify(obj, null, 2);
          } catch (e) {
            // 不是 JSON 就保持原样
          }

          $("meta").textContent = `状态: ${res.status}  | 耗时: ${ms}ms`;
          $("out").textContent = pretty || "(空响应)";
          // ===== 保存历史 =====
          const history = JSON.parse(localStorage.getItem("history") || "[]");

          history.unshift({
            method,
            url,
            body: bodyText,
            time: Date.now(),
          });

          // 只保留 5 条
          const latest = history.slice(0, 5);

          localStorage.setItem("history", JSON.stringify(latest));
          renderHistory();
        } catch (err) {
          $("meta").textContent = "失败";
          $("out").textContent = String(err);
        }
      });
    </script>
  </body>
</html>
