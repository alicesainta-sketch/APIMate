<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>接口小助手</title>
    <style>
      body {
        font-family:
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Helvetica,
          Arial;
        padding: 16px;
        max-width: 900px;
        margin: 0 auto;
      }
      .row {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
      }
      input,
      select,
      textarea,
      button {
        font: inherit;
        padding: 10px;
      }
      input,
      textarea {
        width: 100%;
      }
      textarea {
        min-height: 140px;
      }
      button {
        cursor: pointer;
      }
      pre {
        background: #f6f8fa;
        padding: 12px;
        overflow: auto;
      }
      .muted {
        color: #666;
        font-size: 12px;
      }
      #history button {
        margin: 4px 6px 4px 0;
        padding: 6px 10px;
      }
    </style>
  </head>

  <body>
    <h2>接口小助手</h2>

    <div class="row">
      <select id="method">
        <option>GET</option>
        <option>POST</option>
      </select>
      <input id="url" placeholder="https://api.example.com/..." />
      <button id="send">发送</button>
    </div>

    <div class="row" id="bodyRow">
      <textarea
        id="body"
        placeholder='POST Body（JSON），例如：{"name":"alice"}'
      ></textarea>
    </div>

    <div class="row">
      <textarea
        id="headers"
        placeholder='Headers（JSON），例如：{"Authorization":"Bearer xxx"}'
      ></textarea>
    </div>

    <div class="muted" id="meta">未发送</div>

    <div class="muted">历史（点击回填）</div>
    <div id="history"></div>

    <pre id="out">(结果会显示在这里)</pre>

    <script>
      const $ = (id) => document.getElementById(id);

      // ========= UI：历史渲染 =========
      function renderHistory() {
        const history = JSON.parse(localStorage.getItem("history") || "[]");
        const box = $("history");
        box.innerHTML = "";

        if (history.length === 0) {
          box.textContent = "(暂无)";
          return;
        }

        history.forEach((item, idx) => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.textContent = `${idx + 1}. ${item.method} ${item.url}`;
          btn.addEventListener("click", () => {
            $("method").value = item.method;
            $("url").value = item.url;
            $("body").value = item.body || "";
            $("headers").value = item.headers || "";
            $("method").dispatchEvent(new Event("change"));
          });
          box.appendChild(btn);
        });
      }

      // ========= 网络层：统一 fetch + 超时 + 解析 =========
      async function apiFetch(url, options = {}, timeoutMs = 15000) {
        const controller = new AbortController();
        const timer = setTimeout(() => controller.abort(), timeoutMs);

        try {
          const res = await fetch(url, {
            ...options,
            signal: controller.signal,
          });
          const contentType = res.headers.get("content-type") || "";
          const text = await res.text();

          let data = text;
          let isJson = false;

          // 优先按 content-type 判断，再做容错尝试
          if (contentType.includes("application/json")) {
            try {
              data = JSON.parse(text);
              isJson = true;
            } catch (e) {}
          } else {
            try {
              data = JSON.parse(text);
              isJson = true;
            } catch (e) {}
          }

          return {
            ok: res.ok,
            status: res.status,
            headers: Object.fromEntries(res.headers.entries()),
            isJson,
            data,
            text,
          };
        } catch (err) {
          const isTimeout = String(err).includes("AbortError");
          return {
            ok: false,
            status: 0,
            headers: {},
            isJson: false,
            data: null,
            text: "",
            error: isTimeout ? "请求超时" : String(err),
          };
        } finally {
          clearTimeout(timer);
        }
      }

      // ========= 业务层：把表单输入 -> 请求 + 把响应 -> pretty =========
      async function sendRequest(method, url, bodyText, headersText) {
        const options = { method, headers: {} };

        // 解析自定义 headers
        if (headersText) {
          try {
            const customHeaders = JSON.parse(headersText);
            Object.assign(options.headers, customHeaders);
          } catch (e) {
            throw new Error("Headers JSON 格式错误");
          }
        }

        if (method === "POST") {
          options.headers["Content-Type"] =
            options.headers["Content-Type"] || "application/json";
          options.body = bodyText ? JSON.stringify(JSON.parse(bodyText)) : "{}";
        }

        const r = await apiFetch(url, options);

        let pretty = r.text;
        if (r.isJson && r.data !== null) {
          try {
            pretty = JSON.stringify(r.data, null, 2);
          } catch (e) {}
        }

        return {
          ok: r.ok,
          status: r.status,
          pretty,
          error: r.error,
        };
      }

      // ========= UI：method 切换显示/隐藏 body =========
      $("method").addEventListener("change", () => {
        const isPost = $("method").value === "POST";
        $("bodyRow").style.display = isPost ? "flex" : "none";
      });

      // ========= UI：发送按钮 =========
      $("send").addEventListener("click", async () => {
        const headersText = $("headers").value.trim();
        const method = $("method").value;
        const url = $("url").value.trim();
        const bodyText = $("body").value.trim();

        if (!url) {
          alert("先填 URL");
          return;
        }

        const t0 = performance.now();
        $("meta").textContent = "请求中...";
        $("out").textContent = "";

        try {
          const result = await sendRequest(method, url, bodyText, headersText);
          const ms = Math.round(performance.now() - t0);

          if (!result.ok) {
            $("meta").textContent = `失败 | 耗时: ${ms}ms`;
            $("out").textContent = result.error || "未知错误";
            return;
          }

          $("meta").textContent = `状态: ${result.status} | 耗时: ${ms}ms`;
          $("out").textContent = result.pretty || "(空响应)";

          // 保存历史（包含 headers）
          const history = JSON.parse(localStorage.getItem("history") || "[]");
          history.unshift({
            method,
            url,
            body: bodyText,
            headers: headersText,
            time: Date.now(),
          });
          localStorage.setItem("history", JSON.stringify(history.slice(0, 5)));

          renderHistory();
        } catch (err) {
          $("meta").textContent = "失败";
          $("out").textContent = err?.message ? err.message : String(err);
        }
      });

      // ========= 初始化 =========
      renderHistory();
      $("method").dispatchEvent(new Event("change"));
    </script>
  </body>
</html>
```
